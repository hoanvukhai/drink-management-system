generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// 1. NG∆Ø·ªúI D√ôNG & PH√ÇN QUY·ªÄN (GI·ªÆ NGUY√äN + B·ªî SUNG LINK)
// =====================================================
enum Role {
  EMPLOYEE
  MANAGER
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  name      String?
  role      Role     @default(EMPLOYEE)
  
  // üëá B·ªî SUNG LI√äN K·∫æT: ƒê·ªÉ bi·∫øt ai l√†m g√¨ trong kho v√† nh√¢n s·ª±
  transactions InventoryTransaction[] 
  attendances  Attendance[]           
  shifts       Shift[]
  
  // (Optional: Link t·ªõi Order ƒë·ªÉ bi·∫øt ai b√°n)
  orders       Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// 2. MENU & S·∫¢N PH·∫®M (GI·ªÆ NGUY√äN CODE C≈® C·ª¶A B·∫†N)
// =====================================================
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id         Int         @id @default(autoincrement())
  name       String
  price      Float
  imageUrl   String?
  category   Category    @relation(fields: [categoryId], references: [id])
  categoryId Int
  
  orderItems OrderItem[]
  recipe     Recipe?     // Li√™n k·∫øt 1-1 v·ªõi c√¥ng th·ª©c
  
  // B·ªï sung t·ª´ file c·ªßa b·∫°n (r·∫•t h·ªØu √≠ch ƒë·ªÉ ·∫©n m√≥n h·∫øt h√†ng)
  available  Boolean     @default(true)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

// =====================================================
// 3. B√ÄN & KHU V·ª∞C (GI·ªÆ NGUY√äN CODE C≈® C·ª¶A B·∫†N)
// =====================================================
enum TableStatus {
  AVAILABLE
  OCCUPIED
}

model Zone {
  id        Int      @id @default(autoincrement())
  name      String
  tables    Table[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Table {
  id        Int         @id @default(autoincrement())
  name      String
  capacity  Int         @default(4)
  status    TableStatus @default(AVAILABLE)
  zone      Zone        @relation(fields: [zoneId], references: [id])
  zoneId    Int
  orders    Order[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

// =====================================================
// 4. ƒê∆†N H√ÄNG (POS) (GI·ªÆ NGUY√äN CODE C≈® C·ª¶A B·∫†N)
// =====================================================
enum OrderStatus {
  PENDING    // ƒêang ch·ªù pha ch·∫ø / ƒêang ph·ª•c v·ª•
  READY      // ƒê√£ pha xong
  SERVED     // ƒê√£ mang ra
  COMPLETED  // ƒê√£ thanh to√°n (L√∫c n√†y s·∫Ω tr·ª´ kho)
  CANCELLED  // H·ªßy ƒë∆°n
}

model Order {
  id            Int         @id @default(autoincrement())
  orderNumber   String      @unique @default(uuid()) // T·ª± sinh m√£ ƒë∆°n
  totalAmount   Float       @default(0)
  status        OrderStatus @default(PENDING)
  type          String      @default("DINE_IN")
  
  table         Table?      @relation(fields: [tableId], references: [id])
  tableId       Int?
  
  customerName  String?
  customerPhone String?
  
  // Ng∆∞·ªùi t·∫°o ƒë∆°n
  createdBy     User?       @relation(fields: [createdById], references: [id])
  createdById   Int?        

  // Timing
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  readyAt       DateTime?
  servedAt      DateTime?
  completedAt   DateTime?
  
  items         OrderItem[]
  
  @@index([status])
  @@index([tableId])
}

model OrderItem {
  id          Int       @id @default(autoincrement())
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     Int
  product     Product   @relation(fields: [productId], references: [id])
  productId   Int
  
  quantity    Int
  price       Float     
  note        String?   
  isServed    Boolean   @default(false)
  isCompleted Boolean   @default(false)
  
// üëá QUAN TR·ªåNG: Th√™m tr∆∞·ªùng n√†y ƒë·ªÉ fix l·ªói completedAt
  completedAt DateTime? 
  
  // üëá QUAN TR·ªåNG: Th√™m tr∆∞·ªùng n√†y ƒë·ªÉ fix l·ªói edits
  edits       OrderItemEdit[] 
  
  createdAt   DateTime  @default(now())
  @@index([orderId])
}

// Th√™m model n√†y v√†o cu·ªëi file schema n·∫øu ch∆∞a c√≥
model OrderItemEdit {
  id          Int       @id @default(autoincrement())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  orderItemId Int
  action      String    
  oldValue    String?
  newValue    String?
  reason      String?   // Cho ph√©p null n·∫øu kh√¥ng b·∫Øt bu·ªôc
  userId      Int?
  createdAt   DateTime  @default(now())

  @@index([orderItemId])
}

// =====================================================
// 5. KHO & ƒê·ªäNH L∆Ø·ª¢NG (INVENTORY) - üî• PH·∫¶N ƒê∆Ø·ª¢C CH·ªàNH S·ª¨A
// =====================================================
// T√¥i d√πng m√¥ h√¨nh "Ingredient + Transaction" (Level 2)
// V√¨ n√≥ linh ho·∫°t h∆°n m√¥ h√¨nh "PurchaseOrder" c·ª©ng nh·∫Øc.

model Ingredient {
  id           Int      @id @default(autoincrement())
  name         String   @unique 
  unit         String   // ƒê∆°n v·ªã qu·∫£n l√Ω: "kg", "l√≠t", "h·ªôp", "qu·∫£"
  
  // T·ªìn kho & Gi√° v·ªën
  currentStock Float    @default(0) // S·ªë l∆∞·ª£ng hi·ªán c√≥
  costPrice    Float    @default(0) // Gi√° v·ªën b√¨nh qu√¢n (t·ª± t√≠nh khi nh·∫≠p)
  minStock     Float    @default(0) // C·∫£nh b√°o khi d∆∞·ªõi m·ª©c n√†y
  
  // Li√™n k·∫øt
  transactions InventoryTransaction[] // L·ªãch s·ª≠ bi·∫øn ƒë·ªông
  recipeItems  RecipeIngredient[]     // D√πng trong m√≥n n√†o
  
  updatedAt    DateTime @updatedAt
}

// Th·∫ª kho (Thay th·∫ø cho c·∫£ PurchaseOrder v√† StockTake ph·ª©c t·∫°p)
model InventoryTransaction {
  id           Int             @id @default(autoincrement())
  ingredient   Ingredient      @relation(fields: [ingredientId], references: [id])
  ingredientId Int
  
  change       Float           // S·ªë l∆∞·ª£ng thay ƒë·ªïi: +10 (Nh·∫≠p), -0.5 (B√°n), -1 (V·ª°)
  price        Float           @default(0) // T·ªïng ti·ªÅn nh·∫≠p (ch·ªâ d√πng khi nh·∫≠p h√†ng)
  
  type         TransactionType // Lo·∫°i giao d·ªãch
  note         String?         // "Nh·∫≠p h√†ng Vinamilk", "ƒê∆°n h√†ng #105", "Ki·ªÉm k√™ th√°ng 11"
  
  createdBy    User?           @relation(fields: [userId], references: [id])
  userId       Int?            // Ai l√†m?

  createdAt    DateTime        @default(now())
  
  @@index([ingredientId])
  @@index([type])
}

enum TransactionType {
  IMPORT          // Nh·∫≠p h√†ng (+) -> Thay cho PurchaseOrder
  EXPORT_SALES    // Tr·ª´ khi b√°n h√†ng (-) -> T·ª± ƒë·ªông
  EXPORT_DAMAGE   // H·ªßy h√†ng h·ªèng/v·ª° (-)
  AUDIT           // Ki·ªÉm k√™/C√¢n b·∫±ng kho (+/-) -> Thay cho StockTake
}

// =====================================================
// 6. C√îNG TH·ª®C PHA CH·∫æ (RECIPE)
// =====================================================

model Recipe {
  id          Int                @id @default(autoincrement())
  product     Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   Int                @unique
  description String?            // H∆∞·ªõng d·∫´n chung
  
  steps       RecipeStep[]       // C√°c b∆∞·ªõc l√†m
  ingredients RecipeIngredient[] // ƒê·ªãnh l∆∞·ª£ng
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model RecipeStep {
  id          Int      @id @default(autoincrement())
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId    Int
  stepNumber  Int
  instruction String
  createdAt   DateTime @default(now())

  @@index([recipeId])
}

// B·∫£ng n·ªëi M√≥n ƒÉn v√† Nguy√™n li·ªáu kho
model RecipeIngredient {
  id           Int        @id @default(autoincrement())
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId     Int
  
  // Li√™n k·∫øt tr·ª±c ti·∫øp v·ªõi kho
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId Int
  
  quantity     Float      // ƒê·ªãnh m·ª©c: 1 ly d√πng bao nhi√™u? (V√≠ d·ª•: 0.03 l√≠t)
  
  createdAt    DateTime   @default(now())
  
  @@unique([recipeId, ingredientId])
}

// =====================================================
// 7. NH√ÇN S·ª∞ & CHI PH√ç (L·∫•y t·ª´ file c·ªßa b·∫°n nh∆∞ng g·ªçn h∆°n)
// =====================================================

model Attendance {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  
  checkIn   DateTime @default(now())
  checkOut  DateTime?
  
  note      String?
  createdAt DateTime @default(now())
}

enum ShiftStatus {
  ASSIGNED
  STARTED
  ENDED
}

model Shift {
  id        Int         @id @default(autoincrement())
  user      User        @relation(fields: [userId], references: [id])
  userId    Int
  
  shiftName String      // "Ca S√°ng"
  startTime DateTime
  endTime   DateTime
  status    ShiftStatus @default(ASSIGNED)
  
  createdAt DateTime    @default(now())
}

// B·∫£ng chi ph√≠ (ƒê·ªÉ t√≠nh l√£i r√≤ng: L√£i = Doanh thu - Gi√° v·ªën - Chi ph√≠ n√†y)
model Expense {
  id          Int      @id @default(autoincrement())
  name        String   // "Ti·ªÅn ƒëi·ªán T11"
  amount      Float    // 2.000.000
  type        String   // "UTILITY", "SALARY", "MARKETING", "OTHER"
  note        String?
  date        DateTime @default(now())
}