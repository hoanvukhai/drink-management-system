// backend/prisma/schema.prisma - FIXED VERSION

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// 1. USER & AUTH
// =====================================================
enum Role {
  EMPLOYEE
  MANAGER
  ADMIN
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  name      String?
  role      Role     @default(EMPLOYEE)
  
  transactions InventoryTransaction[] 
  attendances  Attendance[]           
  shifts       Shift[]
  orders       Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================================================
// 2. MENU & PRODUCTS
// =====================================================
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id         Int         @id @default(autoincrement())
  name       String
  price      Float
  imageUrl   String?
  category   Category    @relation(fields: [categoryId], references: [id])
  categoryId Int
  
  orderItems OrderItem[]
  recipe     Recipe?
  available  Boolean     @default(true)

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

// =====================================================
// 3. TABLES & ZONES
// =====================================================
enum TableStatus {
  AVAILABLE
  OCCUPIED
}

model Zone {
  id        Int      @id @default(autoincrement())
  name      String
  tables    Table[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Table {
  id        Int         @id @default(autoincrement())
  name      String
  capacity  Int         @default(4)
  status    TableStatus @default(AVAILABLE)
  zone      Zone        @relation(fields: [zoneId], references: [id])
  zoneId    Int
  orders    Order[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

// =====================================================
// 4. ORDERS (POS)
// =====================================================
enum OrderStatus {
  PENDING
  READY
  SERVED
  COMPLETED
  CANCELLED
}

model Order {
  id            Int         @id @default(autoincrement())
  orderNumber   String      @unique @default(uuid())
  totalAmount   Float       @default(0)
  status        OrderStatus @default(PENDING)
  type          String      @default("DINE_IN")
  
  table         Table?      @relation(fields: [tableId], references: [id])
  tableId       Int?
  
  customerName  String?
  customerPhone String?
  
  createdBy     User?       @relation(fields: [createdById], references: [id])
  createdById   Int?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  readyAt       DateTime?
  servedAt      DateTime?
  completedAt   DateTime?
  
  items         OrderItem[]
  
  @@index([status])
  @@index([tableId])
}

model OrderItem {
  id          Int       @id @default(autoincrement())
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId     Int
  product     Product   @relation(fields: [productId], references: [id])
  productId   Int
  
  quantity    Int
  price       Float
  note        String?
  isServed    Boolean   @default(false)
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  
  edits       OrderItemEdit[]
  
  createdAt   DateTime  @default(now())
  @@index([orderId])
}

model OrderItemEdit {
  id          Int       @id @default(autoincrement())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  orderItemId Int
  action      String
  oldValue    String?
  newValue    String?
  reason      String?
  userId      Int?
  createdAt   DateTime  @default(now())

  @@index([orderItemId])
}

// =====================================================
// 5. üî• INVENTORY SYSTEM - FIXED
// =====================================================

// Nguy√™n li·ªáu kho
model Ingredient {
  id           Int      @id @default(autoincrement())
  name         String   @unique 
  unit         String   // ƒê∆°n v·ªã c∆° s·ªü: "kg", "l√≠t", "h·ªôp"
  
  // T·ªìn kho & Gi√° v·ªën
  currentStock Float    @default(0)
  costPrice    Float    @default(0) // Gi√° v·ªën b√¨nh qu√¢n
  minStock     Float    @default(0) // C·∫£nh b√°o h·∫øt h√†ng
  
  // Relations
  transactions InventoryTransaction[]
  recipeItems  RecipeIngredient[]
  
  updatedAt    DateTime @updatedAt
}

// Th·∫ª kho - L∆∞u m·ªçi bi·∫øn ƒë·ªông
model InventoryTransaction {
  id           Int             @id @default(autoincrement())
  ingredient   Ingredient      @relation(fields: [ingredientId], references: [id])
  ingredientId Int
  
  change       Float           // +10 (Nh·∫≠p), -0.5 (B√°n), -1 (H·ªèng)
  price        Float           @default(0) // T·ªïng ti·ªÅn nh·∫≠p (IMPORT only)
  
  type         TransactionType
  note         String?
  
  createdBy    User?           @relation(fields: [userId], references: [id])
  userId       Int?

  createdAt    DateTime        @default(now())
  
  @@index([ingredientId])
  @@index([type])
}

enum TransactionType {
  IMPORT          // Nh·∫≠p h√†ng (+)
  EXPORT_SALES    // Tr·ª´ khi b√°n (-)
  EXPORT_DAMAGE   // H·ªßy h√†ng h·ªèng (-)
  AUDIT           // Ki·ªÉm k√™ (+/-)
}

// =====================================================
// 6. RECIPE - FIXED
// =====================================================

model Recipe {
  id          Int                @id @default(autoincrement())
  product     Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId   Int                @unique
  description String?
  
  steps       RecipeStep[]
  ingredients RecipeIngredient[]
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model RecipeStep {
  id          Int      @id @default(autoincrement())
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId    Int
  stepNumber  Int
  instruction String
  createdAt   DateTime @default(now())

  @@index([recipeId])
}

// üî• FIX: Li√™n k·∫øt tr·ª±c ti·∫øp v·ªõi Ingredient
model RecipeIngredient {
  id           Int        @id @default(autoincrement())
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId     Int
  
  // üî• CRITICAL: Link to Ingredient table
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId Int
  
  quantity     Float      // ƒê·ªãnh m·ª©c: VD: 0.03 kg cho 1 ly
  
  createdAt    DateTime   @default(now())
  
  @@unique([recipeId, ingredientId])
}

// =====================================================
// 7. HR & EXPENSES
// =====================================================

model Attendance {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  
  checkIn   DateTime @default(now())
  checkOut  DateTime?
  note      String?
  createdAt DateTime @default(now())
}

enum ShiftStatus {
  ASSIGNED
  STARTED
  ENDED
}

model Shift {
  id        Int         @id @default(autoincrement())
  user      User        @relation(fields: [userId], references: [id])
  userId    Int
  
  shiftName String
  startTime DateTime
  endTime   DateTime
  status    ShiftStatus @default(ASSIGNED)
  
  createdAt DateTime    @default(now())
}

model Expense {
  id     Int      @id @default(autoincrement())
  name   String
  amount Float
  type   String
  note   String?
  date   DateTime @default(now())
}